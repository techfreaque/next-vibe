# i18n Patterns

> **Part of NextVibe Framework** (GPL-3.0) - Type-safe internationalization system

**Golden Rule: Translation keys map EXACTLY to folder paths.**

---

## Table of Contents

1. [Overview](#overview)
2. [File Structure](#file-structure)
3. [Translation Key Patterns](#translation-key-patterns)
4. [Type Safety Rules](#type-safety-rules)
5. [Import Patterns](#import-patterns)
6. [Common Mistakes](#common-mistakes)
7. [Debugging](#debugging)
8. [Migration Workflow](#migration-workflow)

---

## Overview

NextVibe uses a **location-based i18n system** where translations are co-located with code. Every module can have its own `i18n/` folder with translations for **en** (English), **de** (German), and **pl** (Polish).

**Key Principles:**

1. **Location-based**: Translations live where they're used
2. **Type-safe**: German/Polish use English types for consistency
3. **Hierarchical**: Parents import only direct children
4. **Immediate feedback**: NO cache - changes reflect instantly in `vibe check`

---

## File Structure

### The ONLY Allowed Structure

```
any-directory/
├── i18n/
│   ├── en/
│   │   └── index.ts    ← ONLY THIS FILE, NOTHING ELSE
│   ├── de/
│   │   └── index.ts    ← ONLY THIS FILE, NOTHING ELSE
│   └── pl/
│       └── index.ts    ← ONLY THIS FILE, NOTHING ELSE
```

### Rules (NO EXCEPTIONS)

1. Each directory level has its own `i18n/` folder
2. Inside `i18n/`: ONLY 3 folders: `en/`, `de/`, `pl/`
3. Inside each language folder: ONLY ONE file: `index.ts`
4. NO other .ts files in language folders
5. NO subdirectories in language folders
6. Parent `index.ts` imports from child `index.ts` files

### Example Structure

```
src/app/api/[locale]/v1/
├── domain/
│   ├── route.ts
│   ├── i18n/
│   │   ├── en/index.ts
│   │   ├── de/index.ts
│   │   └── pl/index.ts
│   └── subdomain/
│       ├── route.ts
│       └── i18n/
│           ├── en/index.ts
│           ├── de/index.ts
│           └── pl/index.ts
```

---

## Translation Key Patterns

### Golden Rule: Keys Map EXACTLY to Folder Paths

**ONLY EXCEPTION: `[locale]` is removed from the path. NO OTHER EXCEPTIONS!**

### Path-to-Key Formula

```
File: src/app/[locale]/story/_components/i18n/en/index.ts

1. Remove src/:     app/[locale]/story/_components/i18n/en/index.ts
2. Remove [locale]: app/story/_components/i18n/en/index.ts
3. Remove /i18n/en/index.ts: app/story/_components
4. Replace / with .: app.story._components
5. Add object path:  app.story._components.{yourObjectPath}
```

### Examples

```typescript
// Story component
src/app/[locale]/story/_components/i18n/en/index.ts → { hero: { title: "..." } }
Key: app.story._components.hero.title

// API endpoint
src/app/api/[locale]/v1/core/user/i18n/en/index.ts → { errors: { notFound: "..." } }
Key: app.api.v1.core.user.errors.notFound

// Admin page
src/app/[locale]/admin/leads/list/i18n/en/index.ts → { table: { email: "..." } }
Key: app.admin.leads.list.table.email
```

### Common Mistakes

```typescript
❌ t("app.story.hero.title")           // Missing _components
❌ t("app.locale.story.hero.title")    // Don't include [locale]
❌ t("app.site.hero.title")            // Wrong folder name (aliases)
❌ t("app.api.user.errors")            // Missing v1.core
```

### Parent Files Must Match Folder Names

```typescript
❌ export const translations = { site: siteTranslations };  // Folder is "story"!
✅ export const translations = { story: storyTranslations }; // Matches folder
```

**If parent uses wrong name:** FIX the parent file, don't use the wrong name in keys.

### Construction Rules

1. Always start with `app.`
2. Include EVERY folder (except `[locale]`)
3. Match folder names EXACTLY (case, underscores, etc.)
4. Hyphens in folder names become camelCase in keys (`user-profile` → `userProfile`)
5. NO aliases, shortcuts, or exceptions

---

## Type Safety Rules

### English File (Source of Truth)

```typescript
// src/app/api/[locale]/v1/domain/i18n/en/index.ts
import { translations as subdomainTranslations } from "../../subdomain/i18n/en";

export const translations = {
  // Own translations
  category: "Domain Category",
  tags: {
    domain: "Domain",
  },
  // Direct children
  subdomain: subdomainTranslations,
};
```

**Rules:**
- `export const translations = { ... }` (NO `as const`)
- Import children from `../../child/i18n/en`
- NO type annotations on English files

### German/Polish Files (Typed from English)

```typescript
// src/app/api/[locale]/v1/domain/i18n/de/index.ts
import type { translations as enTranslations } from "../en";

import { translations as subdomainTranslations } from "../../subdomain/i18n/de";

export const translations: typeof enTranslations = {
  // Own translations (translated)
  category: "Domain Kategorie",
  tags: {
    domain: "Domäne",
  },
  // Direct children
  subdomain: subdomainTranslations,
};
```

**Rules:**
- `import type { translations as enTranslations } from "../en"` at top
- `export const translations: typeof enTranslations = { ... }`
- Import children from same language folder (`../../subdomain/i18n/de`)
- NO `as const` in any file

---

## Import Patterns

### Hierarchical Imports: Direct Children Only

```typescript
// ✅ CORRECT: Parent imports only direct children
import { translations as childTranslations } from "../../child/i18n/en";
import { translations as anotherChildTranslations } from "../../another-child/i18n/en";

export const translations = {
  child: childTranslations,
  anotherChild: anotherChildTranslations,
};
```

```typescript
// ❌ WRONG: Don't import grandchildren directly
import { translations as grandchildTranslations } from "../../child/grandchild/i18n/en";
```

### Naming Conventions

- **Import aliases**: Use descriptive names ending with `Translations`
- **Export keys**: Use camelCase matching the folder name
- **File names**: Always `index.ts` in language folders
- **Folder names**: Use kebab-case matching API routes

### Complex Example

```typescript
// consultation/i18n/en/index.ts
import { translations as adminTranslations } from "../../admin/i18n/en";
import { translations as availabilityTranslations } from "../../availability/i18n/en";
import { translations as createTranslations } from "../../create/i18n/en";
import { translations as listTranslations } from "../../list/i18n/en";

export const translations = {
  admin: adminTranslations,
  availability: availabilityTranslations,
  create: createTranslations,
  list: listTranslations,
};
```

---

## Common Mistakes

### ❌ Multiple Files

```
en/
├── index.ts
├── email.ts     ← DELETE
└── errors.ts    ← DELETE
```

**Fix:** Consolidate into `index.ts`

### ❌ Subdirectories

```
en/
├── index.ts
└── email/       ← DELETE
    └── index.ts
```

**Fix:** Delete subdirectory, merge into parent `index.ts`

### ❌ Using `as const`

```typescript
// ❌ WRONG
export const translations = {...} as const;

// ✅ CORRECT
export const translations = {...};
```

### ❌ Missing `typeof` in German/Polish

```typescript
// ❌ WRONG
export const translations = {...};

// ✅ CORRECT
import type { translations as enTranslations } from "../en";
export const translations: typeof enTranslations = {...};
```

### ❌ Bad Import Paths

```typescript
// ❌ WRONG
import { translations } from "./email";

// ✅ CORRECT
import { translations } from "../../subdomain/i18n/en";
```

---

## Debugging

### ⚡ CRITICAL: NO CACHE - IMMEDIATE FEEDBACK

Changes to translations reflect INSTANTLY when running `vibe check`. NO regeneration, restart, or cache clearing needed.

**If errors persist after fixing:**
1. Key missing from i18n file
2. Path in code incorrect
3. Typo in key or path
4. Structure mismatch (e.g., `error.title` vs `errors.title`)

### Debugging Type Errors

**On error:** `Argument of type '"app.story.privacyPolicy.title"' is not assignable...`

1. Find file: `find src -path "*/i18n/en/*" | grep privacy`
2. Build key from path:
   - Remove `src/`
   - Remove `[locale]`
   - Remove `/i18n/en/index.ts`
   - Replace `/` with `.`
3. Check object structure in file
4. Verify if parent spreads (`...translations`) or nests (`key: translations`)

### Common Errors

```bash
# Duplicate key error
Error: Duplicate key 'response'
→ Fix: Merge duplicate objects in i18n file

# Missing translation key
Error: "app.api.v1.core.user.errors.notFound" is not assignable to parameter of type 'TranslationKey'
→ Fix: Add key to ALL three locale files (en, de, pl)

# Structure mismatch
Error: Property 'title' does not exist
→ Fix: Ensure identical structure across en, de, pl files
```

---

## Migration Workflow

### Fix Violations

**1. Identify violations:**
```bash
find src -path "*/i18n/en/*" -type f  # Should only show index.ts files
find src -path "*/i18n/en/*" -name "*.ts" ! -name "index.ts"  # Find extras
```

**2. Delete extra files:**
```bash
cd {folder}/i18n/en && rm -rf !(index.ts) */
cd {folder}/i18n/de && rm -rf !(index.ts) */
cd {folder}/i18n/pl && rm -rf !(index.ts) */
```

**3. Fix imports:**
```typescript
// WRONG: import from "./email"
// CORRECT: import from "../../imap/i18n/en"

export const translations = {
  imap: imapTranslations,
  emails: { nav: { overview: "Overview" } }, // Inline
};
```

**4. Verify:**
```bash
vibe check {folder}  # Should have 0 errors
```

### Migration Steps

1. **Check BEFORE:** `vibe check {folder}` (note error count)
2. **Find violations:** `find {folder}/i18n/en -name "*.ts" ! -name "index.ts"`
3. **Fix structure:** Delete extra files/folders, fix imports
4. **Update keys:** Change partial paths to full paths (e.g., `leads.title` → `app.admin.leads.title`)
5. **Add missing translations** to all 3 languages (en, de, pl)
6. **Check AFTER:** `vibe check {folder}` (verify 0 errors)

---

## Quick Checklist

Before committing i18n code:

- [ ] Each language folder has ONLY `index.ts`
- [ ] NO extra files or subdirectories
- [ ] English: `export const translations = { ... }` (NO `as const`)
- [ ] German/Polish: `typeof enTranslations` type annotation
- [ ] Identical structure across en, de, pl
- [ ] Keys follow path-to-key formula
- [ ] Parents import only direct children
- [ ] Folder names match export keys (camelCase)
- [ ] NO placeholder translations ("TODO", empty strings)
- [ ] `vibe check` passes with 0 errors

---

## Quick Commands

```bash
# Find violations
find src -path "*/i18n/en/*" -name "*.ts" ! -name "index.ts"

# Delete violations
cd {folder}/i18n/{lang} && rm -rf !(index.ts) */

# Verify
vibe check {folder}

# Check for duplicate keys
grep -r "export const translations" src/app/api/[locale]/v1/core/contact/i18n/en/index.ts
```

---

## See Also

- [Enum Patterns](enum.md) - Translation keys in enums
- [Definition Patterns](definition.md) - Translation keys in field metadata
- [Email Patterns](email.md) - Translation keys in email templates
